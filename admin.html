<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a1a2e; /* Dark background */
        }
        .scrollable-table {
            max-height: 70vh;
            overflow-y: auto;
        }
        .data-table th, .data-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #2d2d44;
        }
        .data-table th {
            background-color: #0f0f1b;
            color: #ffffff;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        .data-table tr:hover {
            background-color: #2d2d44;
        }
        .admin-card {
            background: #252541;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }
        /* Custom Message Box Styles */
        #messageBox {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            padding: 15px 25px;
            border-radius: 8px;
            color: white;
            transition: opacity 0.5s ease-in-out;
            opacity: 0;
            pointer-events: none;
        }
        .message-success { background-color: #4CAF50; }
        .message-error { background-color: #F44336; }
    </style>
</head>
<body class="p-4 md:p-8">

    <!-- Message Box -->
    <div id="messageBox" class="text-sm font-semibold"></div>

    <div class="admin-container max-w-7xl mx-auto rounded-xl overflow-hidden shadow-2xl">
        <header class="bg-gray-800 p-4 flex justify-between items-center">
            <h1 class="text-2xl font-bold text-white flex items-center">
                <i class="fas fa-shield-alt mr-2 text-indigo-400"></i> Admin Panel
            </h1>
            <div class="flex items-center space-x-4">
                <span id="welcomeMessage" class="text-sm text-gray-300">Loading...</span>
                <button onclick="logout()" class="bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-200">
                    <i class="fas fa-sign-out-alt mr-1"></i> Logout
                </button>
            </div>
        </header>

        <main class="p-6 bg-[#1a1a2e] text-white">
            <h2 class="text-3xl font-bold mb-6 text-indigo-400">Database Records</h2>

            <!-- Search and Stats Placeholder -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                <div class="admin-card p-5 rounded-xl">
                    <h3 class="text-lg font-semibold text-gray-400">Total Records</h3>
                    <p id="totalRecords" class="text-3xl font-extrabold mt-1 text-green-400">0</p>
                </div>
                <div class="admin-card p-5 rounded-xl">
                    <h3 class="text-lg font-semibold text-gray-400">Admins Online</h3>
                    <p id="activeAdmins" class="text-3xl font-extrabold mt-1 text-yellow-400">0</p>
                </div>
                <div class="admin-card p-5 rounded-xl">
                    <h3 class="text-lg font-semibold text-gray-400">User ID</h3>
                    <p id="userIdDisplay" class="text-xs break-words mt-1 text-red-400">Loading...</p>
                </div>
            </div>

            <!-- Data Table Section -->
            <div class="admin-card p-5 rounded-xl">
                <h3 class="text-xl font-semibold mb-4 text-white">User Data Table (/user_data)</h3>
                <div id="loadingIndicator" class="text-center py-10 text-lg text-gray-400">
                    <i class="fas fa-spinner fa-spin mr-2"></i> Searching for data...
                </div>
                <div class="scrollable-table hidden" id="dataTableContainer">
                    <table class="data-table min-w-full">
                        <thead id="dataTableHeader">
                            <!-- Table headers will be injected here -->
                        </thead>
                        <tbody id="dataRecordsBody">
                            <!-- Table rows will be injected here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getDatabase, ref, onValue, set } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-database.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Set Firebase logging level (Good practice for debugging)
        setLogLevel('Debug');

        // --- GLOBAL FIREBASE SETUP ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' && __firebase_config !== '' ? __firebase_config : '{}');

        let app;
        let auth;
        let database;
        let currentAdmin = null;

        try {
            if (Object.keys(firebaseConfig).length === 0) {
                console.error("Firebase configuration is missing or empty.");
                document.getElementById('loadingIndicator').textContent = 'Error: Firebase config missing.';
            } else {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                database = getDatabase(app);
            }
        } catch (error) {
            console.error("Firebase initialization failed:", error);
            document.getElementById('loadingIndicator').textContent = 'Error: Firebase initialization failed.';
        }
        // --- END GLOBAL FIREBASE SETUP ---

        /**
         * Custom Message Box implementation (to avoid alert())
         * @param {string} message - The message to display.
         * @param {string} type - 'success' or 'error'.
         */
        function showMessage(message, type) {
            const box = document.getElementById('messageBox');
            box.textContent = message;
            box.className = 'text-sm font-semibold'; // Reset classes
            box.classList.add('transition', 'duration-500', 'ease-in-out', 'message-' + type);
            box.style.opacity = 1;
            box.style.pointerEvents = 'auto';

            setTimeout(() => {
                box.style.opacity = 0;
                box.style.pointerEvents = 'none';
            }, 3000);
        }

        // --- ADMIN ROLE CHECK ---

        // NOTE: This function assumes an admin list is kept in the Realtime Database under 'admins/{uid}'
        // The security rules MUST enforce that only a logged-in user can check this path.
        async function checkAdminAccess(user) {
            if (!database) return false;
            try {
                // Using an empty array for onValue to fetch once, as Realtime Database listeners can act as one-time fetches
                return new Promise(resolve => {
                    const adminRef = ref(database, `admins/${user.uid}`);
                    onValue(adminRef, (snapshot) => {
                        const isAdmin = snapshot.exists() && snapshot.val().role === 'admin';
                        resolve(isAdmin);
                    }, { onlyOnce: true });
                });
            } catch (error) {
                console.error("Error checking admin access:", error);
                return false;
            }
        }

        // --- DATA LOADING & DISPLAY ---

        function loadAllData() {
            if (!database) {
                document.getElementById('loadingIndicator').textContent = 'Database is not initialized.';
                return;
            }

            const dataRef = ref(database, 'user_data');
            const loadingIndicator = document.getElementById('loadingIndicator');
            const dataTableContainer = document.getElementById('dataTableContainer');
            const dataRecordsBody = document.getElementById('dataRecordsBody');
            const dataTableHeader = document.getElementById('dataTableHeader');

            loadingIndicator.classList.remove('hidden');
            dataTableContainer.classList.add('hidden');
            dataRecordsBody.innerHTML = '';
            dataTableHeader.innerHTML = '';
            document.getElementById('totalRecords').textContent = '0';

            // Real-time listener for user_data
            onValue(dataRef, (snapshot) => {
                const data = snapshot.val();
                let records = [];
                let headers = new Set(['Key']); // Always include a key column

                if (data) {
                    // Convert object of objects into an array of records
                    Object.keys(data).forEach(key => {
                        const record = data[key];
                        record.Key = key; // Add the Firebase key as a column
                        records.push(record);
                        // Dynamically collect all possible column headers
                        Object.keys(record).forEach(header => headers.add(header));
                    });
                }

                // Sort headers: 'Key' first, then others alphabetically
                const finalHeaders = ['Key', ...Array.from(headers).filter(h => h !== 'Key').sort()];

                // --- Render Table Header ---
                let headerHtml = '<tr>';
                finalHeaders.forEach(header => {
                    headerHtml += `<th class="uppercase tracking-wider text-xs font-medium">${header}</th>`;
                });
                headerHtml += '</tr>';
                dataTableHeader.innerHTML = headerHtml;

                // --- Render Table Body ---
                let bodyHtml = '';
                records.forEach(record => {
                    bodyHtml += '<tr>';
                    finalHeaders.forEach(header => {
                        // Display the value or an empty string if the property is missing
                        const value = record[header] !== undefined && record[header] !== null
                            ? (typeof record[header] === 'object' ? JSON.stringify(record[header]) : record[header])
                            : '-';
                        bodyHtml += `<td class="text-sm text-gray-300 max-w-xs overflow-hidden truncate">${value}</td>`;
                    });
                    bodyHtml += '</tr>';
                });
                dataRecordsBody.innerHTML = bodyHtml;

                // --- Update Status ---
                document.getElementById('totalRecords').textContent = records.length;
                loadingIndicator.classList.add('hidden');
                dataTableContainer.classList.remove('hidden');
                showMessage(`Successfully loaded ${records.length} records.`, 'success');

            }, (error) => {
                console.error("Firebase Data Fetch Error:", error);
                loadingIndicator.textContent = `Error: Failed to fetch data. ${error.message}`;
                showMessage('Failed to fetch data. See console for details.', 'error');
            });
        }

        // --- STATS UPDATE (Placeholder for actual implementation) ---

        function updateStats() {
            // Placeholder: Could be updated to fetch count of online admins from a separate RTDB node
            // For now, it shows a static value
            document.getElementById('activeAdmins').textContent = '1';
        }

        // --- AUTH & INITIALIZATION ---

        // Logout
        window.logout = function() {
            if (!auth) return;
            signOut(auth).then(() => {
                window.location.href = 'admin_login.html';
            }).catch(error => {
                showMessage(`Logout Error: ${error.message}`, 'error');
            });
        }

        // Initial Auth Setup
        async function initializeAuth() {
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                try {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } catch (error) {
                    console.warn("Custom token sign-in failed, falling back to anonymous:", error.message);
                    await signInAnonymously(auth);
                }
            } else {
                await signInAnonymously(auth);
            }
        }

        // Auth state listener
        onAuthStateChanged(auth, async (user) => {
            if (!user) {
                // Not logged in
                window.location.href = 'admin_login.html';
                return;
            }

            // Display user ID for debugging/reference
            document.getElementById('userIdDisplay').textContent = user.uid;

            // Check if user is an admin
            const isAdmin = await checkAdminAccess(user);
            if (!isAdmin) {
                showMessage('Access denied. Admin privileges required.', 'error');
                // Use setTimeout to allow message box to display before redirection
                setTimeout(() => {
                    signOut(auth).then(() => {
                        window.location.href = 'admin_login.html?reason=denied';
                    });
                }, 2000);
                return;
            }

            // Admin access granted
            currentAdmin = user;
            document.getElementById('welcomeMessage').textContent = `Welcome, ${user.email || user.uid}`;
            loadAllData();
            updateStats();
        });

        // Run initial auth flow
        if (auth) {
            initializeAuth();
        }

    </script>
</body>
</html>
