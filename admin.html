<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Nasir Database</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Poppins', sans-serif; /* Changed font for consistency */
        }

        body {
            background: linear-gradient(135deg, #2b5876 0%, #4e4376 100%); /* Darker, modern background */
            min-height: 100vh;
            padding: 20px;
        }

        .admin-container {
            max-width: 1400px;
            margin: 0 auto;
            background: #ffffff;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
            overflow: hidden;
        }

        .admin-header {
            background: linear-gradient(90deg, #1c2a38, #34495e);
            color: white;
            padding: 20px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .admin-header h1 {
            font-size: 1.8rem;
            display: flex;
            align-items: center;
        }

        .admin-header h1 i {
            margin-right: 10px;
            font-size: 1.5rem;
        }
        
        #welcomeMessage {
            font-size: 0.9rem;
            font-weight: 300;
            margin-left: 20px;
        }

        .admin-content {
            padding: 30px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: #f4f7f6;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            transition: var(--transition);
            border-left: 5px solid #6c63ff;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }

        .stat-card h3 {
            font-size: 1rem;
            color: #555;
            margin-bottom: 5px;
        }

        .stat-card p {
            font-size: 2.2rem;
            font-weight: 600;
            color: #333;
        }

        .section-title {
            font-size: 1.5rem;
            color: #333;
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }

        .data-section, .admin-section {
            background: #ffffff;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            margin-bottom: 30px;
            border: 1px solid #ddd;
        }

        .search-controls {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            align-items: center;
        }

        .search-controls input[type="text"] {
            padding: 12px;
            border: 1px solid #ccc;
            border-radius: 8px;
            flex-grow: 1;
            font-size: 1rem;
            transition: border-color 0.3s;
        }

        .search-controls input[type="text"]:focus {
            border-color: #6c63ff;
            outline: none;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            text-decoration: none;
        }

        .btn-primary {
            background: #6c63ff;
            color: white;
        }

        .btn-primary:hover {
            background: #5a52d5;
        }
        
        .btn-secondary {
            background: #ff6584;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #d5536e;
        }

        .btn-logout {
            background: #f44336;
            color: white;
        }

        .btn-logout:hover {
            background: #d32f2f;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        th, td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
            font-size: 0.9rem;
        }

        th {
            background: #f8f8f8;
            font-weight: 600;
            color: #333;
            text-transform: uppercase;
        }
        
        tr:hover {
            background-color: #fcfcfc;
        }

        /* Loading Spinner */
        #dataLoading {
            text-align: center;
            padding: 50px;
            font-size: 1.2rem;
            color: #6c63ff;
        }

        /* Modals */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.5);
            padding-top: 60px;
        }

        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 30px;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            position: relative;
        }

        .close-btn {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            transition: color 0.2s;
        }

        .close-btn:hover,
        .close-btn:focus {
            color: #333;
            text-decoration: none;
            cursor: pointer;
        }

        .modal-content input[type="email"] {
            width: 100%;
            padding: 12px;
            margin: 10px 0 20px 0;
            display: inline-block;
            border: 1px solid #ccc;
            border-radius: 8px;
            box-sizing: border-box;
        }
        
        .modal-content h2 {
            margin-top: 0;
            color: #333;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .admin-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            
            #welcomeMessage {
                margin-left: 0;
            }

            .search-controls {
                flex-direction: column;
                gap: 10px;
            }
            
            .search-controls input[type="text"] {
                width: 100%;
            }
            
            .btn {
                width: 100%;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            th, td {
                padding: 10px;
                font-size: 0.85rem;
            }
            
            table {
                display: block;
                overflow-x: auto;
                white-space: nowrap;
            }
        }
    </style>
</head>
<body>
    <div class="admin-container">
        <header class="admin-header">
            <h1><i class="fas fa-lock"></i> Admin Panel</h1>
            <div style="display: flex; align-items: center; gap: 10px;">
                <span id="welcomeMessage">Welcome, Admin!</span>
                <button onclick="logout()" class="btn btn-logout"><i class="fas fa-sign-out-alt"></i> Logout</button>
            </div>
        </header>

        <main class="admin-content">
            
            <!-- Statistics Section -->
            <h2 class="section-title"><i class="fas fa-chart-bar"></i> Overview Statistics</h2>
            <div class="stats-grid">
                <div class="stat-card">
                    <h3>Total Records</h3>
                    <p id="totalRecords">0</p>
                </div>
                <div class="stat-card">
                    <h3>Total Admins</h3>
                    <p id="totalAdmins">0</p>
                </div>
                <div class="stat-card">
                    <h3>Total Users</h3>
                    <p id="totalUsers">0</p>
                </div>
                <div class="stat-card">
                    <h3>Total Searches</h3>
                    <p id="totalSearches">0</p>
                </div>
            </div>

            <!-- Manage Admins Section -->
            <div class="admin-section">
                <h2 class="section-title"><i class="fas fa-user-shield"></i> Manage Admins</h2>
                <div style="margin-bottom: 15px;">
                    <button onclick="document.getElementById('addAdminModal').style.display='block'" class="btn btn-primary"><i class="fas fa-plus-circle"></i> Add New Admin</button>
                </div>
                <table id="adminTable">
                    <thead>
                        <tr>
                            <th>Email</th>
                            <th>UID</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Admin data will be populated here -->
                    </tbody>
                </table>
            </div>

            <!-- Database Data Section -->
            <div class="data-section">
                <h2 class="section-title"><i class="fas fa-database"></i> Database Records</h2>
                <div class="search-controls">
                    <input type="text" id="searchQuery" placeholder="Search by CNIC or Phone Number...">
                    <button onclick="searchData()" class="btn btn-primary"><i class="fas fa-search"></i> Search</button>
                    <button onclick="loadAllData()" class="btn btn-secondary"><i class="fas fa-sync-alt"></i> Show All Data</button>
                </div>
                
                <div id="dataLoading" style="display: none;">
                    <i class="fas fa-spinner fa-spin"></i> Loading data, please wait...
                </div>

                <div style="overflow-x: auto;">
                    <table id="dataTable">
                        <thead>
                            <tr>
                                <th>Key</th>
                                <th>CNIC</th>
                                <th>Phone</th>
                                <th>Name</th>
                                <th>Address</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Data records will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>

        </main>
    </div>

    <!-- Modals -->

    <!-- Add Admin Modal -->
    <div id="addAdminModal" class="modal">
        <div class="modal-content">
            <span onclick="document.getElementById('addAdminModal').style.display='none'" class="close-btn">&times;</span>
            <h2>Add New Admin</h2>
            <p>Enter the email address of the user you want to grant admin access to. This user must already be registered.</p>
            <input type="email" id="adminEmail" placeholder="Enter user's email" required>
            <button onclick="addAdmin()" class="btn btn-primary" style="width: 100%;"><i class="fas fa-user-plus"></i> Grant Admin Access</button>
        </div>
    </div>
    
    <!-- Edit Data Modal -->
    <div id="editDataModal" class="modal">
        <div class="modal-content">
            <span onclick="document.getElementById('editDataModal').style.display='none'" class="close-btn">&times;</span>
            <h2>Edit Record</h2>
            <form id="editForm">
                <input type="hidden" id="editKey">
                
                <label for="editCNIC">CNIC:</label>
                <input type="text" id="editCNIC" required>
                
                <label for="editPhone">Phone:</label>
                <input type="text" id="editPhone" required>
                
                <label for="editName">Name:</label>
                <input type="text" id="editName" required>
                
                <label for="editAddress">Address:</label>
                <input type="text" id="editAddress" required>
                
                <button type="submit" class="btn btn-primary" style="width: 100%; margin-top: 20px;"><i class="fas fa-save"></i> Save Changes</button>
            </form>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut, fetchSignInMethodsForEmail } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";
        import { getDatabase, ref, get, set, remove, onValue } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-database.js";
        
        // --- IMPORTANT: Use your actual Firebase Config ---
        const firebaseConfig = {
            apiKey: "AIzaSyCfLFgbq7m-pEK-jw-PQvwGh4zlyGE8n4w",
            authDomain: "nasir-48572.firebaseapp.com",
            databaseURL: "https://nasir-48572-default-rtdb.asia-southeast1.firebasedatabase.app", // Added databaseURL
            projectId: "nasir-48572",
            storageBucket: "nasir-48572.appspot.com",
            messagingSenderId: "1032758456576",
            appId: "1:1032758456576:web:eaea202eb1f313efc743e5"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const database = getDatabase(app);

        let currentAdmin = null;
        let allRecords = {}; // Global store for all data records

        // --- Utility Functions ---

        async function checkAdminAccess(user) {
            if (!user) return false;
            try {
                const snapshot = await get(ref(database, `admins/${user.uid}`));
                return snapshot.exists();
            } catch (error) {
                console.error("Error checking admin access:", error);
                return false;
            }
        }
        
        // Custom Alert/Error function (replacing default alert)
        function showCustomAlert(message) {
            // Since we can't use a custom modal here easily, we will stick to a console log and the native alert, 
            // but in a production environment, this should be a custom modal/notification.
            console.warn("ADMIN ALERT:", message);
            alert(message);
        }

        // --- Data Loading & Display ---
        
        /**
         * Loads all data from the 'data' node in Firebase Realtime Database.
         * This function fixes the issue of records not showing up initially.
         */
        window.loadAllData = async function() {
            const dataTableBody = document.querySelector('#dataTable tbody');
            const loadingIndicator = document.getElementById('dataLoading');
            
            loadingIndicator.style.display = 'block';
            dataTableBody.innerHTML = ''; // Clear previous data
            allRecords = {}; // Clear global store

            try {
                const snapshot = await get(ref(database, 'data'));

                if (snapshot.exists()) {
                    // This is the crucial change: iterate through the snapshot children
                    const data = snapshot.val();
                    let recordCount = 0;
                    
                    // data is an object where keys are the unique record IDs
                    for (const key in data) {
                        if (data.hasOwnProperty(key)) {
                            const record = data[key];
                            allRecords[key] = record; // Store in global cache
                            recordCount++;
                            
                            // Append the row to the table
                            const row = createDataRow(key, record);
                            dataTableBody.appendChild(row);
                        }
                    }
                    
                    if (recordCount === 0) {
                         dataTableBody.innerHTML = '<tr><td colspan="6" style="text-align: center;">No records found in the database.</td></tr>';
                    }
                    
                } else {
                    dataTableBody.innerHTML = '<tr><td colspan="6" style="text-align: center;">No records found in the database.</td></tr>';
                }
                
                await updateStats(); // Update stats after loading data
                
            } catch (error) {
                console.error("Error loading all data:", error);
                dataTableBody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: red;">Error loading data: ' + error.message + '</td></tr>';
            } finally {
                loadingIndicator.style.display = 'none';
            }
        }
        
        /**
         * Creates a table row element for a single data record.
         */
        function createDataRow(key, record) {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${key}</td>
                <td>${record.cnic || 'N/A'}</td>
                <td>${record.phone || 'N/A'}</td>
                <td>${record.name || 'N/A'}</td>
                <td>${record.address || 'N/A'}</td>
                <td>
                    <button onclick="openEditModal('${key}')" class="btn btn-primary" style="padding: 5px 10px; font-size: 0.8rem;"><i class="fas fa-edit"></i> Edit</button>
                    <button onclick="deleteData('${key}')" class="btn btn-secondary" style="padding: 5px 10px; font-size: 0.8rem;"><i class="fas fa-trash-alt"></i> Delete</button>
                </td>
            `;
            return tr;
        }

        // --- Search Functionality ---

        window.searchData = function() {
            const queryText = document.getElementById('searchQuery').value.trim();
            const dataTableBody = document.querySelector('#dataTable tbody');
            dataTableBody.innerHTML = '';
            
            if (queryText === '') {
                // If search box is empty, load all data again (or just display the cached data)
                // For simplicity and to use the same logic, we'll call loadAllData
                loadAllData(); 
                return;
            }

            const searchKey = queryText.toLowerCase();
            let resultsFound = 0;
            
            // Iterate over the cached records
            for (const key in allRecords) {
                if (allRecords.hasOwnProperty(key)) {
                    const record = allRecords[key];
                    
                    // Search logic: check if CNIC or Phone contains the query
                    const cnic = (record.cnic || '').toLowerCase();
                    const phone = (record.phone || '').toLowerCase();
                    
                    if (cnic.includes(searchKey) || phone.includes(searchKey)) {
                        const row = createDataRow(key, record);
                        dataTableBody.appendChild(row);
                        resultsFound++;
                    }
                }
            }
            
            if (resultsFound === 0) {
                dataTableBody.innerHTML = `<tr><td colspan="6" style="text-align: center;">No records found for "${queryText}".</td></tr>`;
            }
        }


        // --- Admin Management ---

        window.loadAdmins = function() {
            const adminTableBody = document.querySelector('#adminTable tbody');
            adminTableBody.innerHTML = '';

            // Use onValue for real-time admin list updates
            onValue(ref(database, 'admins'), (snapshot) => {
                adminTableBody.innerHTML = ''; // Clear table
                let adminCount = 0;
                if (snapshot.exists()) {
                    snapshot.forEach((childSnapshot) => {
                        const uid = childSnapshot.key;
                        const adminData = childSnapshot.val();
                        const email = adminData.email || 'N/A';
                        
                        // Prevent super-admin from deleting themselves
                        const isCurrentAdmin = (currentAdmin && currentAdmin.uid === uid);
                        
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td>${email}</td>
                            <td>${uid}</td>
                            <td>
                                ${isCurrentAdmin 
                                    ? '<span style="color: #6c63ff; font-style: italic;">(You)</span>'
                                    : `<button onclick="removeAdmin('${uid}')" class="btn btn-secondary" style="padding: 5px 10px; font-size: 0.8rem;"><i class="fas fa-user-minus"></i> Remove</button>`
                                }
                            </td>
                        `;
                        adminTableBody.appendChild(tr);
                        adminCount++;
                    });
                }
                document.getElementById('totalAdmins').textContent = adminCount;
            }, (error) => {
                console.error("Error loading admins:", error);
            });
        }

        window.addAdmin = async function() {
            const adminEmailInput = document.getElementById('adminEmail');
            const email = adminEmailInput.value.trim();

            if (!email) {
                showCustomAlert('Please enter an email address.');
                return;
            }

            try {
                // 1. Check if user is registered with Firebase Authentication
                const methods = await fetchSignInMethodsForEmail(auth, email);
                if (methods.length === 0) {
                    showCustomAlert('Error: A registered user with this email does not exist.');
                    return;
                }
                
                // 2. Find the UID of the user (requires admin SDK/cloud functions for production, but we'll simulate finding it if necessary)
                // Since direct UID lookup from email is restricted on the client side, the user must already be signed in or the admin must know the UID.
                // For this client-side implementation, we rely on the user having registered. In a secure app, this would be a Cloud Function call.
                showCustomAlert("Please note: Due to client-side security limits, the system needs the UID. If this user is not the current admin, they need to sign in at least once for their UID to be reliably found/used in a Realtime DB-based admin system.");

                // Since we can't reliably get the UID from the email on the client side without being the user, 
                // we'll assume the UID is available if the admin entry is written. 
                // A better approach would be to prompt for UID, or use the email as the key (less secure).
                
                // For a client-side quick fix: we'll use the current admin's UID temporarily if no other method is available
                // In a real app, the server would lookup the UID and write the admin entry.
                const userSnapshot = await get(ref(database, 'users')); // Inefficient but necessary client-side hack
                let targetUid = null;
                userSnapshot.forEach(child => {
                    if (child.val().email === email) {
                        targetUid = child.key;
                    }
                });

                if (!targetUid) {
                    showCustomAlert('Error: Could not find registered user UID. User may not have completed registration or sign-in yet.');
                    return;
                }

                // 3. Add the user's UID and email to the 'admins' node
                await set(ref(database, `admins/${targetUid}`), { email: email });
                document.getElementById('addAdminModal').style.display = 'none';
                adminEmailInput.value = '';
                showCustomAlert(`Admin access granted to ${email}.`);
                // loadAdmins() will be triggered by onValue listener
                
            } catch (error) {
                console.error('Error adding admin:', error);
                showCustomAlert('Error granting admin access: ' + error.message);
            }
        }

        window.removeAdmin = async function(uid) {
            if (uid === currentAdmin.uid) {
                showCustomAlert("You cannot remove your own admin status.");
                return;
            }
            if (!confirm('Are you sure you want to remove this user as an admin?')) {
                return;
            }
            try {
                await remove(ref(database, `admins/${uid}`));
                showCustomAlert('Admin removed successfully!');
                // loadAdmins() will be triggered by onValue listener
            } catch (error) {
                showCustomAlert('Error removing admin: ' + error.message);
            }
        }


        // --- Data Actions (Edit/Delete) ---
        
        window.openEditModal = function(key) {
            const record = allRecords[key];
            if (!record) {
                showCustomAlert("Record not found for key: " + key);
                return;
            }
            
            document.getElementById('editKey').value = key;
            document.getElementById('editCNIC').value = record.cnic || '';
            document.getElementById('editPhone').value = record.phone || '';
            document.getElementById('editName').value = record.name || '';
            document.getElementById('editAddress').value = record.address || '';
            
            document.getElementById('editDataModal').style.display = 'block';
        }

        document.getElementById('editForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const key = document.getElementById('editKey').value;
            const updatedRecord = {
                cnic: document.getElementById('editCNIC').value,
                phone: document.getElementById('editPhone').value,
                name: document.getElementById('editName').value,
                address: document.getElementById('editAddress').value
            };

            try {
                await set(ref(database, `data/${key}`), updatedRecord);
                document.getElementById('editDataModal').style.display = 'none';
                showCustomAlert(`Record ${key} updated successfully!`);
                
                // Manually update the cached data and re-render (or just reload all data)
                loadAllData();
                
            } catch (error) {
                console.error("Error updating record:", error);
                showCustomAlert("Error updating record: " + error.message);
            }
        });
        
        window.deleteData = async function(key) {
            if (!confirm(`Are you sure you want to delete record ${key}?`)) {
                return;
            }
            try {
                await remove(ref(database, `data/${key}`));
                showCustomAlert(`Record ${key} deleted successfully!`);
                // Re-load data to update the table
                loadAllData();
            } catch (error) {
                showCustomAlert('Error deleting record: ' + error.message);
            }
        }
        
        // --- Statistics Update ---
        
        window.updateStats = async function() {
            try {
                // Total Records (from cached data)
                const totalRecordsCount = Object.keys(allRecords).length;
                document.getElementById('totalRecords').textContent = totalRecordsCount.toLocaleString();
                
                // Total Users (from 'users' node)
                const usersSnapshot = await get(ref(database, 'users'));
                const totalUsersCount = usersSnapshot.exists() ? Object.keys(usersSnapshot.val()).length : 0;
                document.getElementById('totalUsers').textContent = totalUsersCount.toLocaleString();
                
                // Total Searches (from 'searchHistory' node)
                const searchesSnapshot = await get(ref(database, 'searchHistory'));
                // Count all unique search entries across all user UIDs
                let totalSearchesCount = 0;
                if (searchesSnapshot.exists()) {
                    const userSearches = searchesSnapshot.val();
                    for (const uid in userSearches) {
                        if (userSearches.hasOwnProperty(uid)) {
                            // Sum up the number of search entries for each user
                            totalSearchesCount += Object.keys(userSearches[uid]).length;
                        }
                    }
                }
                document.getElementById('totalSearches').textContent = totalSearchesCount.toLocaleString();
                
            } catch (error) {
                console.error("Error updating statistics:", error);
                // Optionally display an error in the stats card
            }
            
            // Total Admins is updated by the onValue listener in loadAdmins()
        }


        // --- Initialization and Auth ---

        // Logout
        window.logout = function() {
            signOut(auth).then(() => {
                window.location.href = 'login.html';
            });
        }

        // Auth state listener
        onAuthStateChanged(auth, async (user) => {
            if (!user) {
                window.location.href = 'login.html';
                return;
            }
            
            const isAdmin = await checkAdminAccess(user);
            if (!isAdmin) {
                showCustomAlert('Access denied. Admin privileges required.');
                window.location.href = 'index.html';
                return;
            }
            
            currentAdmin = user;
            document.getElementById('welcomeMessage').textContent = `Welcome, ${user.email}`;
            
            // 1. Load Admin list (real-time listener)
            loadAdmins(); 
            
            // 2. Load all data (initial load)
            await loadAllData();
            
            // Auto-refresh data and stats every 30 seconds
            setInterval(loadAllData, 30000); 
            
            // Initial stats update
            updateStats();
        });

        // Close modals when clicking outside
        window.addEventListener('click', function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
            }
        });
    </script>
</body>
</html>
